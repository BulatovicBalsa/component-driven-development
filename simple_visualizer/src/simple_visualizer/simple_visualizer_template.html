<style>
.node {
  cursor: pointer;
  color: #3182bd;

}

.link {
  fill: none;
  stroke: #9ecae1;
  stroke-width: 1.5px;
}

#main-svg-{{name}} {
    width: 100%;
    height: 100%;
}

.active-node {
    stroke: black;
    stroke-width: 2px;
}

</style>
<script>
    function nodeClick(el){
        d3.select(".active-node").select("circle").style("fill","white");
        d3.select(".active-node").classed("active-node",false);
        d3.select(el).classed("active-node",true);
        d3.select(el).select("circle").style("fill","red");
    }
</script>
<svg id="main-svg-{{name}}">

</svg>
<script>
    var nodes={
        // Prodavnice
        {% for n in nodes %}
            "node_{{n.id}}": {
                name: "node_{{n.id}}",
            },
        {% endfor %}
    };

    var links=[
        {% for e in edges %}
            {source: "node_{{e.src.id}}", target: "node_{{e.dest.id}}"},
        {% endfor %}
    ];


    links.forEach(function(link) {
        link.source = nodes[link.source];
        link.target = nodes[link.target];
    });

    var g = d3.select('#main-svg-{{name}}')
        .call(d3.behavior.zoom().on("zoom", function () {
            // Svaki put prilikom okidanja dogadjaja zoom-a (npr. rotacija tockica misa),
            // poziva se ova funkcija koja radi translaciju i skaliranje na osnovu
            // parametara koje cita iz dogadjaja
            console.log("okida se dogadjaj")
            g.attr("transform", "translate(" + d3.event.translate + ")" + " scale(" + d3.event.scale + ")")
        }))
        .append('g');


    // Force layout vrsi numericku simulaciju n-tela (n-cestica).
    // https://d3-wiki.readthedocs.io/zh_CN/master/Force-Layout/
    var force = d3.layout.force() // kreiranje force layout-a
        .size([700, 700]) // raspoloziv prostor za iscrtavanje
        .nodes(d3.values(nodes)) // dodavanje informacija o cvorovima grafa
        .links(links) // dodavanje informacije o ivicama grafa
        .on("tick", tick) // Dogadjaj tick okida se prilikokm svakog koraka simulacije.
                          // Tada se poziva dolenavedena "tick" funckija koja koriguje pozicije
                          // elemenata grafa.
                          // Vise informacija mozete pronaci ovde:
                          // https://d3-wiki.readthedocs.io/zh_CN/master/Force-Layout/#tick
        .linkDistance(300) // duzina ivice grafa
        .charge(-100) // koliko da se elementi odbijaju (pozitivna vrednost kaze koliko se elementi privlace)
        .start(); //pokreni simulaciju

    var drag = d3.behavior.drag()
    .on("dragstart", function() { d3.event.sourceEvent.stopPropagation(); })
    .on("drag", function() { /* handle drag event here */ });

    var drag = force.drag()
        .on("dragstart", function() { d3.event.sourceEvent.stopPropagation(); });

    console.log(force.nodes());

    // Stvarno iscrtavanje linkova koji su prikazani linijama.
    var link = g.selectAll('.link')
        .data(links)
        .enter().append('line')
        .attr('class', 'link');

    // Stvarno iscrtavanje cvorova reprezentovanih g tagom.
    var node = g.selectAll('.node')
        .data(force.nodes()) //add
        .enter().append('g')
        .attr('class', 'node')
        .attr('id', function(d){return d.name;})
        .on('click',function(){
           nodeClick(this);
        });

    var radius=30;
    var textSize=20;
    d3.selectAll('.node').append('circle')
        .attr('r', radius+textSize)
        .style('fill', 'white')
        .style('stroke', 'black')
        .style('stroke-width', '1.5px')
        .each(function(d) {
            d3.select("g#"+d.name)
            .append('text')
            .attr('text-anchor','middle')
            .attr('font-size',textSize)
            .attr('font-family','sans-serif')
            .attr('fill','green')
            .text(d.name);
        });


    function tick(e) {
        // Korak simulacije koji koriguje pozicije cvorova i ivica grafa.

        // translacija cvorova
        node.attr("transform", function(d) {
            return "translate(" + d.x + "," + d.y + ")";
        })
            // Omogucavamo interaktivno prevlacenje cvorova.
            // Vise informacija na
            // https://d3-wiki.readthedocs.io/zh_CN/master/Force-Layout/#drag
            .call(force.drag);

        // Korekcija pozicija ivica (linkova)
        link.attr('x1', function(d) { return d.source.x; })
            .attr('y1', function(d) { return d.source.y; })
            .attr('x2', function(d) { return d.target.x; })
            .attr('y2', function(d) { return d.target.y; });

    }

</script>
